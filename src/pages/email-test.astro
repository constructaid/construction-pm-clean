---
/**
 * Email Integration Test Page
 * Test the AI email parsing and task creation workflow
 */
import Layout from '../layouts/Layout.astro';

export const prerender = false;
---

<Layout title="Email Integration Test - ConstructAid">
  <div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white border-b border-gray-200 shadow-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-3xl font-heading font-light text-gray-900">Email Integration Test</h1>
            <p class="text-gray-600 mt-2">Test AI-powered email parsing and task creation</p>
          </div>
          <a href="/projects/1/tasks" class="px-4 py-2 bg-ca-teal text-white rounded-lg hover:opacity-90">
            View Tasks
          </a>
        </div>
      </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- How It Works -->
      <div class="bg-white rounded-lg border border-gray-200 shadow-ca-sm p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">üìß How Email Integration Works</h2>
        <div class="space-y-3 text-gray-700">
          <p><strong>1. Forward emails to your project:</strong></p>
          <div class="ml-6 bg-gray-50 p-3 rounded border border-gray-200 font-mono text-sm">
            project-162-mockingbird@tasks.constructaid.com
          </div>

          <p class="mt-4"><strong>2. AI automatically extracts:</strong></p>
          <ul class="ml-6 list-disc space-y-1">
            <li>Task title and description</li>
            <li>Priority and category (RFI, Submittal, Inspection, etc.)</li>
            <li>Due dates from natural language</li>
            <li>Assigned person from email signature</li>
            <li>Location, cost code, blockers</li>
            <li>Related document numbers (RFI #, Submittal #, etc.)</li>
          </ul>

          <p class="mt-4"><strong>3. Task auto-created if confidence ‚â• 70%</strong></p>
          <p class="ml-6 text-sm text-gray-600">Lower confidence emails are queued for manual review</p>
        </div>
      </div>

      <!-- Test Email Simulator -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Left: Email Input -->
        <div class="bg-white rounded-lg border border-gray-200 shadow-ca-sm p-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">üìù Simulate Email</h2>

          <form id="email-test-form" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Project ID</label>
              <input
                type="number"
                id="project-id"
                value="1"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ca-teal"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">From Email</label>
              <input
                type="email"
                id="from-email"
                value="john.architect@designfirm.com"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ca-teal"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">From Name</label>
              <input
                type="text"
                id="from-name"
                value="John Architect"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ca-teal"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Subject</label>
              <input
                type="text"
                id="subject"
                value="URGENT: RFI #045 - Electrical panel type clarification"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ca-teal"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Email Body</label>
              <textarea
                id="body"
                rows="8"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ca-teal"
              >Hi Team,

We need to clarify the electrical panel specification for Building A basement. The submittal shows Type 1 panels but we require Type 3R for the outdoor application.

This is blocking the rough-in work scheduled for next Tuesday. Can Jane from your team review the updated submittal by Friday?

Location: Building A - Basement electrical room (DIV 26)

Thanks,
John Architect
Design Firm LLC</textarea>
            </div>

            <!-- Sample Email Templates -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Load Sample Email:</label>
              <div class="flex flex-wrap gap-2">
                <button type="button" onclick="loadSample('rfi')" class="px-3 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">RFI</button>
                <button type="button" onclick="loadSample('submittal')" class="px-3 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">Submittal</button>
                <button type="button" onclick="loadSample('inspection')" class="px-3 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">Inspection</button>
                <button type="button" onclick="loadSample('safety')" class="px-3 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">Safety</button>
                <button type="button" onclick="loadSample('change-order')" class="px-3 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">Change Order</button>
              </div>
            </div>

            <button
              type="submit"
              class="w-full px-4 py-3 bg-ca-orange text-white rounded-lg hover:opacity-90 font-medium text-lg"
            >
              ü§ñ Process Email with AI
            </button>
          </form>
        </div>

        <!-- Right: Results -->
        <div class="bg-white rounded-lg border border-gray-200 shadow-ca-sm p-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">üéØ Parsing Results</h2>

          <div id="results-container" class="space-y-4">
            <div class="text-center py-12 text-gray-400">
              <svg class="mx-auto h-12 w-12 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
              </svg>
              <p>Submit an email to see parsing results</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Email Activity -->
      <div class="mt-6 bg-white rounded-lg border border-gray-200 shadow-ca-sm p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">üì¨ Recent Email Activity</h2>
        <div id="recent-emails" class="space-y-3">
          <p class="text-gray-500 text-center py-8">No recent email activity</p>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  // Sample email templates
  const sampleEmails = {
    rfi: {
      from: 'mike.superintendent@gc.com',
      fromName: 'Mike Johnson',
      subject: 'RFI #012 - Foundation waterproofing detail',
      body: `Hi Sarah,

Can you clarify the waterproofing detail at the foundation wall per sheet S-102?

The specification section 07 13 00 calls for 60mil membrane, but the detail shows 40mil. We need this resolved by next Monday before we pour the foundation walls.

Location: North foundation wall

Thanks,
Mike Johnson
GC Superintendent`
    },
    submittal: {
      from: 'vendor@hvac.com',
      fromName: 'HVAC Vendor',
      subject: 'Submittal #023 - Rooftop units ready for review',
      body: `Good morning,

Please review the attached shop drawings for the rooftop HVAC units (DIV 23).

We need approval by Friday to maintain the delivery schedule. The units are scheduled to ship in 3 weeks.

Let me know if you need any additional information.

Best regards,
HVAC Systems Inc.`
    },
    inspection: {
      from: 'inspector@city.gov',
      fromName: 'Building Inspector',
      subject: 'Fire marshal inspection required - URGENT',
      body: `URGENT: Fire marshal inspection needed before we can proceed with interior finishes.

Please schedule the fire sprinkler rough-in inspection ASAP. We're available tomorrow or Thursday.

Building A, all floors.

City Building Department`
    },
    safety: {
      from: 'safety@gc.com',
      fromName: 'Safety Officer',
      subject: 'Safety Issue - Scaffolding needs immediate attention',
      body: `SAFETY ALERT:

The scaffolding on the east side of Building B is missing guardrails. This needs to be corrected immediately before any work continues in that area.

All work on east side is on hold until this is resolved.

Safety Officer
(555) 123-4567`
    },
    'change-order': {
      from: 'owner@client.com',
      fromName: 'Property Owner',
      subject: 'Change Order Request - Additional outlets in conference rooms',
      body: `Hi Team,

We'd like to add 4 additional electrical outlets in each conference room (Rooms 201, 202, 301).

Can you provide a cost estimate and timeline impact? We need this approved by the end of the week.

Thanks,
Property Owner`
    },
  };

  // Load sample email
  (window as any).loadSample = function(type: string) {
    const sample = sampleEmails[type];
    if (!sample) return;

    document.getElementById('from-email')!.value = sample.from;
    document.getElementById('from-name')!.value = sample.fromName;
    document.getElementById('subject')!.value = sample.subject;
    document.getElementById('body')!.value = sample.body;
  };

  // Handle form submission
  document.getElementById('email-test-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const resultsContainer = document.getElementById('results-container')!;
    resultsContainer.innerHTML = `
      <div class="text-center py-8">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-ca-orange mx-auto mb-4"></div>
        <p class="text-gray-600">Processing email with AI...</p>
      </div>
    `;

    const emailData = {
      projectId: parseInt((document.getElementById('project-id') as HTMLInputElement).value),
      from: (document.getElementById('from-email') as HTMLInputElement).value,
      fromName: (document.getElementById('from-name') as HTMLInputElement).value,
      to: 'project@constructaid.com',
      subject: (document.getElementById('subject') as HTMLInputElement).value,
      body: (document.getElementById('body') as HTMLTextAreaElement).value,
      receivedAt: new Date().toISOString(),
    };

    try {
      const response = await fetch('/api/email/inbound', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(emailData),
      });

      const result = await response.json();

      if (result.success) {
        displayResults(result);
        addToRecentActivity(emailData, result);
      } else {
        resultsContainer.innerHTML = `
          <div class="bg-red-50 border border-red-200 rounded-lg p-4">
            <p class="text-red-800">‚ùå Error: ${result.error}</p>
          </div>
        `;
      }
    } catch (error) {
      resultsContainer.innerHTML = `
        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
          <p class="text-red-800">‚ùå Failed to process email</p>
        </div>
      `;
    }
  });

  function displayResults(result: any) {
    const container = document.getElementById('results-container')!;
    const parsed = result.emailRecord.parsed;
    const task = parsed.task;

    const confidenceColor = result.emailRecord.confidence >= 80 ? 'green' :
                           result.emailRecord.confidence >= 70 ? 'blue' :
                           result.emailRecord.confidence >= 50 ? 'yellow' : 'red';

    container.innerHTML = `
      <!-- Confidence Score -->
      <div class="bg-${confidenceColor}-50 border border-${confidenceColor}-200 rounded-lg p-4">
        <div class="flex items-center justify-between mb-2">
          <span class="font-semibold text-${confidenceColor}-900">AI Confidence</span>
          <span class="text-2xl font-bold text-${confidenceColor}-700">${result.emailRecord.confidence}%</span>
        </div>
        <div class="w-full bg-${confidenceColor}-200 rounded-full h-2">
          <div class="bg-${confidenceColor}-600 h-2 rounded-full" style="width: ${result.emailRecord.confidence}%"></div>
        </div>
      </div>

      <!-- Action Required -->
      <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
        <div class="flex items-center justify-between">
          <span class="font-medium text-gray-700">Requires Action</span>
          <span class="px-3 py-1 rounded-full text-sm font-medium ${parsed.requiresAction ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
            ${parsed.requiresAction ? '‚úì Yes' : '‚óã No'}
          </span>
        </div>
      </div>

      <!-- Matched Patterns -->
      ${parsed.matchedPatterns?.length > 0 ? `
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <p class="font-medium text-blue-900 mb-2">Matched Patterns</p>
          <div class="flex flex-wrap gap-2">
            ${parsed.matchedPatterns.map(p => `<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-sm">${p}</span>`).join('')}
          </div>
        </div>
      ` : ''}

      <!-- Extracted Task Data -->
      <div class="border border-gray-200 rounded-lg p-4">
        <h3 class="font-semibold text-gray-900 mb-3">Extracted Task Information</h3>
        <dl class="space-y-2 text-sm">
          <div class="flex justify-between">
            <dt class="text-gray-600">Title:</dt>
            <dd class="font-medium text-gray-900 text-right ml-4">${task.title || '-'}</dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-gray-600">Category:</dt>
            <dd class="font-medium text-gray-900">${task.category || '-'}</dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-gray-600">Priority:</dt>
            <dd class="font-medium text-gray-900">${task.priority || '-'}</dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-gray-600">Due Date:</dt>
            <dd class="font-medium text-gray-900">${task.dueDate || '-'}</dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-gray-600">Assigned To:</dt>
            <dd class="font-medium text-gray-900">${task.assignedToName || '-'}</dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-gray-600">Location:</dt>
            <dd class="font-medium text-gray-900">${task.location || '-'}</dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-gray-600">Cost Code:</dt>
            <dd class="font-medium text-gray-900">${task.costCode || '-'}</dd>
          </div>
          ${task.blockers ? `
            <div class="pt-2 border-t border-gray-200">
              <dt class="text-gray-600 mb-1">Blockers:</dt>
              <dd class="text-sm text-red-700 bg-red-50 p-2 rounded">${task.blockers}</dd>
            </div>
          ` : ''}
          ${task.relatedDocumentNumber ? `
            <div class="flex justify-between">
              <dt class="text-gray-600">Related Doc:</dt>
              <dd class="font-medium text-gray-900">${task.relatedDocumentType} #${task.relatedDocumentNumber}</dd>
            </div>
          ` : ''}
        </dl>
      </div>

      <!-- AI Reasoning -->
      <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
        <p class="font-medium text-gray-700 mb-1">AI Reasoning</p>
        <p class="text-sm text-gray-600">${parsed.reasoning}</p>
      </div>

      <!-- Result Status -->
      ${result.taskId ? `
        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
          <p class="font-semibold text-green-900 mb-2">‚úÖ Task Created Successfully</p>
          <p class="text-sm text-green-700">Task ID: ${result.taskId}</p>
          <a href="/projects/${result.emailRecord.projectId}/tasks" class="inline-block mt-3 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
            View Task ‚Üí
          </a>
        </div>
      ` : `
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
          <p class="font-semibold text-yellow-900 mb-1">‚è∏Ô∏è Awaiting Manual Review</p>
          <p class="text-sm text-yellow-700">${result.reason || 'Confidence below threshold'}</p>
        </div>
      `}
    `;
  }

  function addToRecentActivity(emailData: any, result: any) {
    const container = document.getElementById('recent-emails')!;
    const timestamp = new Date().toLocaleTimeString();

    const activityHtml = `
      <div class="border border-gray-200 rounded-lg p-4">
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <p class="font-medium text-gray-900">${emailData.subject}</p>
            <p class="text-sm text-gray-600 mt-1">From: ${emailData.fromName} &lt;${emailData.from}&gt;</p>
            <p class="text-xs text-gray-500 mt-1">Processed at ${timestamp}</p>
          </div>
          <div class="ml-4">
            <span class="px-2 py-1 rounded text-xs font-medium ${result.taskId ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
              ${result.taskId ? 'Task Created' : 'Needs Review'}
            </span>
          </div>
        </div>
      </div>
    `;

    if (container.querySelector('p')) {
      container.innerHTML = '';
    }

    container.insertAdjacentHTML('afterbegin', activityHtml);
  }
</script>
