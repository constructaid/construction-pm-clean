---
/**
 * Bid Package Detail Page - View and manage individual bid package
 */
import ProjectLayout from '../../../../layouts/ProjectLayout.astro';
import { db } from '../../../../lib/db';
import { projects, bidPackages, costEstimates, subcontractorQuotes, mwbeParticipation } from '../../../../lib/db/schema';
import { eq } from 'drizzle-orm';
import { CSI_SECTIONS } from '../../../../lib/data/csi-sections';

const { id, packageId } = Astro.params;
const projectId = parseInt(id!);
const bidPackageId = parseInt(packageId!);

// Fetch project details
const [project] = await db.select().from(projects).where(eq(projects.id, projectId));

if (!project) {
  return Astro.redirect('/projects');
}

// Fetch bid package
const [bidPackage] = await db.select().from(bidPackages).where(eq(bidPackages.id, bidPackageId));

if (!bidPackage) {
  return Astro.redirect(`/projects/${projectId}/bid-packages`);
}

// Fetch linked estimates
const linkedEstimates = await db
  .select()
  .from(costEstimates)
  .where(eq(costEstimates.bidPackageId, bidPackageId));

// Fetch all estimates for the project (for linking)
const allEstimates = await db
  .select()
  .from(costEstimates)
  .where(eq(costEstimates.projectId, projectId));

const availableEstimates = allEstimates.filter(e => !e.bidPackageId || e.bidPackageId === bidPackageId);

// Calculate total value from linked estimates
const totalEstimatedValue = linkedEstimates.reduce((sum, est) => sum + (est.totalEstimatedCost || 0), 0);

// Fetch subcontractor quotes
const quotes = await db
  .select()
  .from(subcontractorQuotes)
  .where(eq(subcontractorQuotes.bidPackageId, bidPackageId));

// Calculate total quoted value
const totalQuotedValue = quotes.reduce((sum, quote) => sum + (quote.totalAmount || 0), 0);
const acceptedQuotesValue = quotes.filter(q => q.isAccepted).reduce((sum, quote) => sum + (quote.totalAmount || 0), 0);

// Fetch M/WBE participants
const mwbeParticipants = await db
  .select()
  .from(mwbeParticipation)
  .where(eq(mwbeParticipation.bidPackageId, bidPackageId));

// Calculate M/WBE totals
const totalMWBEAmount = mwbeParticipants.reduce((sum, p) => sum + (p.contractAmount || 0), 0);
const committedMWBEAmount = mwbeParticipants.filter(p => p.isCommitted).reduce((sum, p) => sum + (p.contractAmount || 0), 0);
const mwbePercentage = totalEstimatedValue > 0 ? Math.round((totalMWBEAmount / totalEstimatedValue) * 100) : 0;

const statusColors = {
  draft: 'bg-gray-700 text-gray-300',
  in_preparation: 'bg-blue-900 text-blue-300',
  submitted: 'bg-yellow-900 text-yellow-300',
  under_review: 'bg-purple-900 text-purple-300',
  awarded: 'bg-green-900 text-green-300',
  not_awarded: 'bg-red-900 text-red-300',
  withdrawn: 'bg-gray-700 text-gray-400',
  expired: 'bg-gray-700 text-gray-500',
};

const statusColor = statusColors[bidPackage.status] || 'bg-gray-700 text-gray-300';
---

<ProjectLayout title={`${bidPackage.title} - ${project.name}`} projectId={projectId}>
  <div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-start">
      <div>
        <div class="flex items-center gap-3 mb-2">
          <h1 class="text-3xl font-heading font-light text-white">{bidPackage.title}</h1>
          <span class={`px-3 py-1 rounded-full text-xs font-medium ${statusColor}`}>
            {bidPackage.status.replace('_', ' ').toUpperCase()}
          </span>
        </div>
        <p class="text-gray-400">Bid #{bidPackage.bidNumber}</p>
      </div>
      <div class="flex gap-3">
        <button
          onclick="updateStatus()"
          class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
        >
          ‚úèÔ∏è Update Status
        </button>
        <a
          href={`/projects/${projectId}/bid-packages`}
          class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors"
        >
          ‚Üê Back to Packages
        </a>
      </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
      <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
        <div class="text-gray-400 text-sm mb-1">Linked Estimates</div>
        <div class="text-2xl font-bold text-white">{linkedEstimates.length}</div>
      </div>
      <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
        <div class="text-gray-400 text-sm mb-1">Sub Quotes</div>
        <div class="text-2xl font-bold text-blue-400">{quotes.length}</div>
      </div>
      <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
        <div class="text-gray-400 text-sm mb-1">Total Estimated Value</div>
        <div class="text-lg font-bold text-green-400">
          ${(totalEstimatedValue / 100).toLocaleString()}
        </div>
      </div>
      <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
        <div class="text-gray-400 text-sm mb-1">Bid Due Date</div>
        <div class="text-lg font-bold text-white">
          {new Date(bidPackage.bidDueDate).toLocaleDateString()}
        </div>
      </div>
      <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
        <div class="text-gray-400 text-sm mb-1">Project Duration</div>
        <div class="text-lg font-bold text-white">
          {bidPackage.projectDuration ? `${bidPackage.projectDuration} days` : 'N/A'}
        </div>
      </div>
    </div>

    <!-- Package Details -->
    <div class="bg-gray-800 rounded-lg border border-gray-700 p-6">
      <h2 class="text-xl font-heading font-light text-white mb-4">Package Details</h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <h3 class="text-sm font-medium text-gray-400 mb-2">Bid Information</h3>
          <div class="space-y-2">
            <div class="flex justify-between">
              <span class="text-gray-400">Bid Type:</span>
              <span class="text-white font-medium">
                {bidPackage.bidType.replace(/_/g, ' ').replace(/\b\w/g, (l: string) => l.toUpperCase())}
              </span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-400">Owner Type:</span>
              <span class="text-white font-medium">{bidPackage.ownerType || 'N/A'}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-400">Owner:</span>
              <span class="text-white font-medium">{bidPackage.ownerName || 'N/A'}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-400">Est. Contract Value:</span>
              <span class="text-white font-medium">
                {bidPackage.estimatedContractValue
                  ? `$${(bidPackage.estimatedContractValue / 100).toLocaleString()}`
                  : 'N/A'}
              </span>
            </div>
          </div>
        </div>

        <div>
          <h3 class="text-sm font-medium text-gray-400 mb-2">Requirements</h3>
          <div class="space-y-2">
            <div class="flex items-center gap-2">
              {bidPackage.requiresBidBond ? (
                <span class="text-green-400">‚úì</span>
              ) : (
                <span class="text-gray-600">‚úó</span>
              )}
              <span class="text-gray-300">Bid Bond</span>
            </div>
            <div class="flex items-center gap-2">
              {bidPackage.requiresPerformanceBond ? (
                <span class="text-green-400">‚úì</span>
              ) : (
                <span class="text-gray-600">‚úó</span>
              )}
              <span class="text-gray-300">Performance Bond</span>
            </div>
            <div class="flex items-center gap-2">
              {bidPackage.requiresPaymentBond ? (
                <span class="text-green-400">‚úì</span>
              ) : (
                <span class="text-gray-600">‚úó</span>
              )}
              <span class="text-gray-300">Payment Bond</span>
            </div>
            {bidPackage.requiresMWBE && (
              <div class="p-3 bg-green-900/20 border border-green-800 rounded-lg mt-2">
                <div class="flex items-center gap-2 text-green-400 text-sm font-medium">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                  </svg>
                  <span>M/WBE Required: {bidPackage.mwbeGoalPercentage}% goal</span>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>

      {bidPackage.description && (
        <div class="mt-6 pt-6 border-t border-gray-700">
          <h3 class="text-sm font-medium text-gray-400 mb-2">Description</h3>
          <p class="text-gray-300">{bidPackage.description}</p>
        </div>
      )}
    </div>

    <!-- Linked Estimates -->
    <div class="bg-gray-800 rounded-lg border border-gray-700 p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-heading font-light text-white">Linked Cost Estimates</h2>
        {availableEstimates.length > linkedEstimates.length && (
          <button
            onclick="linkEstimate()"
            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium"
          >
            üîó Link Estimate
          </button>
        )}
      </div>

      {linkedEstimates.length === 0 ? (
        <div class="text-center py-8">
          <div class="text-gray-400 mb-4">
            <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
          </div>
          <p class="text-gray-400 mb-4">No estimates linked to this bid package yet.</p>
          {availableEstimates.length > 0 && (
            <button
              onclick="linkEstimate()"
              class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium"
            >
              üîó Link Your First Estimate
            </button>
          )}
        </div>
      ) : (
        <div class="space-y-3">
          {linkedEstimates.map((estimate) => {
            const estimateStatusColors = {
              draft: 'bg-gray-700 text-gray-300',
              in_progress: 'bg-blue-900 text-blue-300',
              under_review: 'bg-yellow-900 text-yellow-300',
              approved: 'bg-green-900 text-green-300',
              rejected: 'bg-red-900 text-red-300',
              finalized: 'bg-purple-900 text-purple-300',
            };

            const estStatusColor = estimateStatusColors[estimate.status] || 'bg-gray-700 text-gray-300';

            return (
              <div class="flex items-center justify-between p-4 bg-gray-900 rounded-lg border border-gray-700 hover:border-green-600 transition-colors">
                <div class="flex-1">
                  <div class="flex items-center gap-3 mb-1">
                    <h3 class="text-white font-medium">{estimate.title}</h3>
                    <span class={`px-2 py-1 rounded-full text-xs font-medium ${estStatusColor}`}>
                      {estimate.status.replace('_', ' ').toUpperCase()}
                    </span>
                  </div>
                  <p class="text-sm text-gray-400">Estimate #: {estimate.estimateNumber}</p>
                  <p class="text-sm text-green-400 font-medium mt-1">
                    ${(estimate.totalEstimatedCost / 100).toLocaleString()}
                  </p>
                </div>
                <div class="flex items-center gap-2">
                  <a
                    href={`/projects/${projectId}/estimating/${estimate.id}`}
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                  >
                    View
                  </a>
                  <button
                    onclick={`unlinkEstimate(${estimate.id})`}
                    class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium"
                  >
                    Unlink
                  </button>
                </div>
              </div>
            );
          })}
        </div>
      )}
    </div>

    <!-- Subcontractor Quotes -->
    <div class="bg-gray-800 rounded-lg border border-gray-700 p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-heading font-light text-white">Subcontractor Quotes</h2>
        <button
          onclick="addQuote()"
          class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium"
        >
          ‚ûï Add Quote
        </button>
      </div>

      {quotes.length === 0 ? (
        <div class="text-center py-8">
          <div class="text-gray-400 mb-4">
            <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
          </div>
          <p class="text-gray-400 mb-4">No subcontractor quotes yet for this bid package.</p>
          <button
            onclick="addQuote()"
            class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium"
          >
            ‚ûï Add Your First Quote
          </button>
        </div>
      ) : (
        <div class="space-y-3">
          {quotes.map((quote) => {
            const isExpired = quote.quoteValidUntil && new Date(quote.quoteValidUntil) < new Date();

            return (
              <div class="flex items-center justify-between p-4 bg-gray-900 rounded-lg border border-gray-700 hover:border-blue-600 transition-colors">
                <div class="flex-1">
                  <div class="flex items-center gap-3 mb-1">
                    <h3 class="text-white font-medium">{quote.subcontractorName}</h3>
                    {quote.isAccepted && (
                      <span class="px-2 py-1 rounded-full text-xs font-medium bg-green-900 text-green-300">
                        ACCEPTED
                      </span>
                    )}
                    {quote.isIncludedInBid && (
                      <span class="px-2 py-1 rounded-full text-xs font-medium bg-purple-900 text-purple-300">
                        IN BID
                      </span>
                    )}
                    {isExpired && (
                      <span class="px-2 py-1 rounded-full text-xs font-medium bg-red-900 text-red-300">
                        EXPIRED
                      </span>
                    )}
                  </div>
                  <p class="text-sm text-gray-400">CSI Division: {quote.csiDivision}</p>
                  <p class="text-sm text-gray-300 mt-1">{quote.scopeOfWork}</p>
                  <div class="flex gap-4 mt-2">
                    <div>
                      <span class="text-xs text-gray-500">Quote Amount:</span>
                      <span class="text-sm text-blue-400 font-medium ml-1">
                        ${(quote.totalAmount / 100).toLocaleString()}
                      </span>
                    </div>
                    {quote.quoteValidUntil && (
                      <div>
                        <span class="text-xs text-gray-500">Valid Until:</span>
                        <span class="text-sm text-gray-300 ml-1">
                          {new Date(quote.quoteValidUntil).toLocaleDateString()}
                        </span>
                      </div>
                    )}
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <button
                    onclick={`toggleQuoteAcceptance(${quote.id}, ${!quote.isAccepted})`}
                    class={`px-4 py-2 ${quote.isAccepted ? 'bg-gray-600' : 'bg-green-600'} text-white rounded-lg hover:opacity-80 transition-colors font-medium`}
                  >
                    {quote.isAccepted ? 'Reject' : 'Accept'}
                  </button>
                  <button
                    onclick={`deleteQuote(${quote.id})`}
                    class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium"
                  >
                    Delete
                  </button>
                </div>
              </div>
            );
          })}

          {quotes.length > 0 && (
            <div class="mt-4 p-4 bg-gray-900 rounded-lg border border-gray-700">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <div class="text-sm text-gray-400">Total Quotes Received</div>
                  <div class="text-2xl font-bold text-blue-400">{quotes.length}</div>
                </div>
                <div>
                  <div class="text-sm text-gray-400">Accepted Quotes Value</div>
                  <div class="text-2xl font-bold text-green-400">
                    ${(acceptedQuotesValue / 100).toLocaleString()}
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      )}
    </div>

    <!-- M/WBE Participation -->
    {bidPackage.requiresMWBE && (
      <div class="bg-gray-800 rounded-lg border border-green-700 p-6">
        <div class="flex justify-between items-center mb-4">
          <div>
            <h2 class="text-xl font-heading font-light text-white">M/WBE Participation</h2>
            <p class="text-sm text-gray-400 mt-1">
              Goal: {bidPackage.mwbeGoalPercentage}% | Current: {mwbePercentage}%
              {mwbePercentage >= (bidPackage.mwbeGoalPercentage || 0) ? (
                <span class="ml-2 text-green-400 font-medium">‚úì Goal Met</span>
              ) : (
                <span class="ml-2 text-yellow-400 font-medium">‚ö† Below Goal</span>
              )}
            </p>
          </div>
          <button
            onclick="addMWBEParticipant()"
            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium"
          >
            ‚ûï Add M/WBE
          </button>
        </div>

        {mwbeParticipants.length === 0 ? (
          <div class="text-center py-8">
            <div class="text-gray-400 mb-4">
              <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
              </svg>
            </div>
            <p class="text-gray-400 mb-4">No M/WBE participants added yet.</p>
            <button
              onclick="addMWBEParticipant()"
              class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium"
            >
              ‚ûï Add First M/WBE Participant
            </button>
          </div>
        ) : (
          <div class="space-y-3">
            {mwbeParticipants.map((participant) => (
              <div class="flex items-center justify-between p-4 bg-gray-900 rounded-lg border border-gray-700">
                <div class="flex-1">
                  <div class="flex items-center gap-3 mb-1">
                    <h3 class="text-white font-medium">{participant.companyName}</h3>
                    {participant.certificationType && (
                      <span class="px-2 py-1 rounded-full text-xs font-medium bg-purple-900 text-purple-300">
                        {participant.certificationType}
                      </span>
                    )}
                    {participant.isCommitted && (
                      <span class="px-2 py-1 rounded-full text-xs font-medium bg-blue-900 text-blue-300">
                        COMMITTED
                      </span>
                    )}
                    {participant.isAwarded && (
                      <span class="px-2 py-1 rounded-full text-xs font-medium bg-green-900 text-green-300">
                        AWARDED
                      </span>
                    )}
                  </div>
                  {participant.certificationNumber && (
                    <p class="text-sm text-gray-400">Cert #: {participant.certificationNumber}</p>
                  )}
                  <p class="text-sm text-gray-300 mt-1">{participant.scopeOfWork}</p>
                  <div class="flex gap-4 mt-2">
                    {participant.csiDivision && (
                      <div>
                        <span class="text-xs text-gray-500">CSI Division:</span>
                        <span class="text-sm text-gray-300 ml-1">{participant.csiDivision}</span>
                      </div>
                    )}
                    <div>
                      <span class="text-xs text-gray-500">Contract Amount:</span>
                      <span class="text-sm text-green-400 font-medium ml-1">
                        ${(participant.contractAmount / 100).toLocaleString()}
                      </span>
                    </div>
                    {participant.percentageOfTotal && (
                      <div>
                        <span class="text-xs text-gray-500">% of Total:</span>
                        <span class="text-sm text-white font-medium ml-1">{participant.percentageOfTotal}%</span>
                      </div>
                    )}
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <button
                    onclick={`toggleMWBECommitment(${participant.id}, ${!participant.isCommitted})`}
                    class={`px-4 py-2 ${participant.isCommitted ? 'bg-gray-600' : 'bg-blue-600'} text-white rounded-lg hover:opacity-80 transition-colors font-medium`}
                  >
                    {participant.isCommitted ? 'Uncommit' : 'Commit'}
                  </button>
                  <button
                    onclick={`deleteMWBEParticipant(${participant.id})`}
                    class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium"
                  >
                    Delete
                  </button>
                </div>
              </div>
            ))}

            <div class="mt-4 p-4 bg-gray-900 rounded-lg border border-gray-700">
              <div class="grid grid-cols-3 gap-4">
                <div>
                  <div class="text-sm text-gray-400">Total M/WBE Participants</div>
                  <div class="text-2xl font-bold text-purple-400">{mwbeParticipants.length}</div>
                </div>
                <div>
                  <div class="text-sm text-gray-400">Committed M/WBE Value</div>
                  <div class="text-2xl font-bold text-blue-400">
                    ${(committedMWBEAmount / 100).toLocaleString()}
                  </div>
                </div>
                <div>
                  <div class="text-sm text-gray-400">M/WBE Percentage</div>
                  <div class={`text-2xl font-bold ${mwbePercentage >= (bidPackage.mwbeGoalPercentage || 0) ? 'text-green-400' : 'text-yellow-400'}`}>
                    {mwbePercentage}%
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    )}
  </div>
</ProjectLayout>

<!-- CSI Autocomplete Script -->
<script is:inline src="/js/csi-autocomplete.js"></script>

<script define:vars={{ projectId, bidPackageId, availableEstimates, bidPackage, quotes, mwbeParticipants, totalEstimatedValue, CSI_SECTIONS }}>
  async function updateStatus() {
    const statuses = [
      { value: 'draft', label: 'Draft' },
      { value: 'in_preparation', label: 'In Preparation' },
      { value: 'submitted', label: 'Submitted' },
      { value: 'under_review', label: 'Under Review' },
      { value: 'awarded', label: 'Awarded' },
      { value: 'not_awarded', label: 'Not Awarded' },
      { value: 'withdrawn', label: 'Withdrawn' },
      { value: 'expired', label: 'Expired' },
    ];

    const modal = document.createElement('div');
    modal.id = 'status-modal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
    modal.innerHTML = `
      <div class="bg-gray-800 rounded-lg shadow-xl max-w-md w-full">
        <div class="bg-gray-800 border-b border-gray-700 px-6 py-4 flex justify-between items-center">
          <h2 class="text-xl font-heading font-light text-white">Update Bid Package Status</h2>
          <button onclick="closeStatusModal()" class="text-gray-400 hover:text-white transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>

        <form id="status-form" class="p-6 space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">New Status</label>
            <select
              id="newStatus"
              required
              class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-green-600"
            >
              ${statuses.map(s => `
                <option value="${s.value}" ${s.value === bidPackage.status ? 'selected' : ''}>${s.label}</option>
              `).join('')}
            </select>
          </div>

          <div class="flex justify-end gap-3 pt-4">
            <button
              type="button"
              onclick="closeStatusModal()"
              class="px-6 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium"
            >
              Update Status
            </button>
          </div>
        </form>
      </div>
    `;

    document.body.appendChild(modal);

    const form = document.getElementById('status-form');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const newStatus = document.getElementById('newStatus').value;

      const response = await fetch(`/api/bidding/packages/${bidPackageId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus }),
      });

      const result = await response.json();
      if (result.success) {
        window.location.reload();
      } else {
        alert('Error updating status: ' + result.error);
      }
    });
  }

  async function linkEstimate() {
    const unlinked = availableEstimates.filter(e => !e.bidPackageId);

    if (unlinked.length === 0) {
      alert('No available estimates to link. All estimates are already linked to bid packages.');
      return;
    }

    const modal = document.createElement('div');
    modal.id = 'link-modal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
    modal.innerHTML = `
      <div class="bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full">
        <div class="bg-gray-800 border-b border-gray-700 px-6 py-4 flex justify-between items-center">
          <h2 class="text-xl font-heading font-light text-white">Link Estimate to Bid Package</h2>
          <button onclick="closeLinkModal()" class="text-gray-400 hover:text-white transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>

        <div class="p-6">
          <p class="text-gray-400 mb-4">Select an estimate to link to this bid package:</p>
          <div class="space-y-2">
            ${unlinked.map(est => `
              <button
                onclick="performLinkEstimate(${est.id})"
                class="w-full p-4 bg-gray-900 rounded-lg border border-gray-700 hover:border-green-600 transition-colors text-left"
              >
                <div class="flex justify-between items-center">
                  <div>
                    <h3 class="text-white font-medium">${est.title}</h3>
                    <p class="text-sm text-gray-400">Estimate #: ${est.estimateNumber}</p>
                  </div>
                  <span class="text-green-400 font-medium">
                    $${(est.totalEstimatedCost / 100).toLocaleString()}
                  </span>
                </div>
              </button>
            `).join('')}
          </div>
        </div>
      </div>
    `;

    document.body.appendChild(modal);
  }

  async function performLinkEstimate(estimateId) {
    const response = await fetch(`/api/bidding/packages/${bidPackageId}/estimates`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ estimateId }),
    });

    const result = await response.json();
    if (result.success) {
      window.location.reload();
    } else {
      alert('Error linking estimate: ' + result.error);
    }
  }

  async function unlinkEstimate(estimateId) {
    if (!confirm('Are you sure you want to unlink this estimate from the bid package?')) {
      return;
    }

    const response = await fetch(`/api/bidding/packages/${bidPackageId}/estimates`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ estimateId }),
    });

    const result = await response.json();
    if (result.success) {
      window.location.reload();
    } else {
      alert('Error unlinking estimate: ' + result.error);
    }
  }

  function closeStatusModal() {
    const modal = document.getElementById('status-modal');
    if (modal) modal.remove();
  }

  function closeLinkModal() {
    const modal = document.getElementById('link-modal');
    if (modal) modal.remove();
  }

  async function addQuote() {
    const modal = document.createElement('div');
    modal.id = 'add-quote-modal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
    modal.innerHTML = `
      <div class="bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="bg-gray-800 border-b border-gray-700 px-6 py-4 flex justify-between items-center sticky top-0">
          <h2 class="text-xl font-heading font-light text-white">Add Subcontractor Quote</h2>
          <button onclick="closeQuoteModal()" class="text-gray-400 hover:text-white transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>

        <form id="add-quote-form" class="p-6 space-y-4">
          <!-- Subcontractor Information -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-300 mb-2">Subcontractor Name *</label>
              <input
                type="text"
                id="subcontractorName"
                required
                placeholder="e.g., ABC Plumbing Inc."
                class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-green-600"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Email</label>
              <input
                type="email"
                id="subcontractorEmail"
                placeholder="contact@abcplumbing.com"
                class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-green-600"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Phone</label>
              <input
                type="tel"
                id="subcontractorPhone"
                placeholder="(555) 123-4567"
                class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-green-600"
              />
            </div>
          </div>

          <!-- Quote Information -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Quote Number</label>
              <input
                type="text"
                id="quoteNumber"
                placeholder="Q-2025-001"
                class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-green-600"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">CSI Division *</label>
              <div class="relative">
                <input
                  type="text"
                  id="quote-csi-search"
                  placeholder="Type CSI code or search by work type (e.g., 'plumbing', '22')..."
                  autocomplete="off"
                  class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-green-600"
                />
                <input type="hidden" id="quote-csi-code" required />
                <input type="hidden" id="quote-csi-division" />
                <div id="quote-csi-dropdown" class="absolute z-50 w-full mt-1 bg-gray-800 border border-gray-600 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden"></div>
              </div>
              <p class="text-xs text-gray-400 mt-1">Start typing to search CSI codes or descriptions</p>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Scope of Work *</label>
            <textarea
              id="scopeOfWork"
              required
              rows="3"
              placeholder="Describe the scope of work covered by this quote..."
              class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-green-600"
            ></textarea>
          </div>

          <!-- Pricing -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Quoted Amount *</label>
              <input
                type="number"
                id="quotedAmount"
                required
                placeholder="50000"
                step="0.01"
                class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-green-600"
              />
              <p class="text-xs text-gray-500 mt-1">Enter amount in dollars</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Tax Amount</label>
              <input
                type="number"
                id="taxAmount"
                placeholder="4000"
                step="0.01"
                class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-green-600"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Total Amount *</label>
              <input
                type="number"
                id="totalAmount"
                required
                placeholder="54000"
                step="0.01"
                class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-green-600"
              />
            </div>
          </div>

          <!-- Dates -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Quote Date</label>
              <input
                type="date"
                id="quoteDate"
                class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-green-600"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Valid Until</label>
              <input
                type="date"
                id="quoteValidUntil"
                class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-green-600"
              />
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Notes</label>
            <textarea
              id="notes"
              rows="2"
              placeholder="Additional notes about this quote..."
              class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-green-600"
            ></textarea>
          </div>

          <div class="flex justify-end gap-3 pt-4">
            <button
              type="button"
              onclick="closeQuoteModal()"
              class="px-6 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium"
            >
              Add Quote
            </button>
          </div>
        </form>
      </div>
    `;

    document.body.appendChild(modal);

    // Initialize CSI autocomplete for quotes
    let quoteCsiCode = '';
    let quoteCsiDivision = '';
    const quoteCSIAutocomplete = new CSIAutocomplete({
      searchInputId: 'quote-csi-search',
      dropdownId: 'quote-csi-dropdown',
      onSelect: (code, division, title) => {
        quoteCsiCode = code;
        quoteCsiDivision = division;
        document.getElementById('quote-csi-code').value = code;
        document.getElementById('quote-csi-division').value = division;
      }
    });

    const form = document.getElementById('add-quote-form');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = {
        bidPackageId,
        subcontractorName: document.getElementById('subcontractorName').value,
        subcontractorEmail: document.getElementById('subcontractorEmail').value || null,
        subcontractorPhone: document.getElementById('subcontractorPhone').value || null,
        quoteNumber: document.getElementById('quoteNumber').value || null,
        csiDivision: quoteCsiCode || document.getElementById('quote-csi-code').value,
        scopeOfWork: document.getElementById('scopeOfWork').value,
        quotedAmount: Math.round(parseFloat(document.getElementById('quotedAmount').value) * 100),
        taxAmount: document.getElementById('taxAmount').value
          ? Math.round(parseFloat(document.getElementById('taxAmount').value) * 100)
          : 0,
        totalAmount: Math.round(parseFloat(document.getElementById('totalAmount').value) * 100),
        quoteDate: document.getElementById('quoteDate').value || null,
        quoteValidUntil: document.getElementById('quoteValidUntil').value || null,
        notes: document.getElementById('notes').value || null,
      };

      const response = await fetch('/api/bidding/quotes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData),
      });

      const result = await response.json();
      if (result.success) {
        window.location.reload();
      } else {
        alert('Error adding quote: ' + result.error);
      }
    });
  }

  async function toggleQuoteAcceptance(quoteId, isAccepted) {
    const response = await fetch(`/api/bidding/quotes/${quoteId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ isAccepted }),
    });

    const result = await response.json();
    if (result.success) {
      window.location.reload();
    } else {
      alert('Error updating quote: ' + result.error);
    }
  }

  async function deleteQuote(quoteId) {
    if (!confirm('Are you sure you want to delete this quote?')) {
      return;
    }

    const response = await fetch(`/api/bidding/quotes/${quoteId}`, {
      method: 'DELETE',
    });

    const result = await response.json();
    if (result.success) {
      window.location.reload();
    } else {
      alert('Error deleting quote: ' + result.error);
    }
  }

  function closeQuoteModal() {
    const modal = document.getElementById('add-quote-modal');
    if (modal) modal.remove();
  }

  async function addMWBEParticipant() {
    const modal = document.createElement('div');
    modal.id = 'add-mwbe-modal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
    modal.innerHTML = `
      <div class="bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="bg-gray-800 border-b border-gray-700 px-6 py-4 flex justify-between items-center sticky top-0">
          <h2 class="text-xl font-heading font-light text-white">Add M/WBE Participant</h2>
          <button onclick="closeMWBEModal()" class="text-gray-400 hover:text-white transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>

        <form id="add-mwbe-form" class="p-6 space-y-4">
          <!-- Company Information -->
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Company Name *</label>
            <input
              type="text"
              id="companyName"
              required
              placeholder="e.g., ABC Construction Inc."
              class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-green-600"
            />
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Certification Type</label>
              <select
                id="certificationType"
                class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-green-600"
              >
                <option value="">Select...</option>
                <option value="MBE">MBE (Minority Business Enterprise)</option>
                <option value="WBE">WBE (Women Business Enterprise)</option>
                <option value="DBE">DBE (Disadvantaged Business Enterprise)</option>
                <option value="HUB">HUB (Historically Underutilized Business)</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Certification Number</label>
              <input
                type="text"
                id="certificationNumber"
                placeholder="CERT-2025-001"
                class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-green-600"
              />
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">CSI Division</label>
              <div class="relative">
                <input
                  type="text"
                  id="mwbe-csi-search"
                  placeholder="Type CSI code or search by work type (e.g., 'concrete', '03')..."
                  autocomplete="off"
                  class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-green-600"
                />
                <input type="hidden" id="mwbe-csi-code" />
                <input type="hidden" id="mwbe-csi-division" />
                <div id="mwbe-csi-dropdown" class="absolute z-50 w-full mt-1 bg-gray-800 border border-gray-600 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden"></div>
              </div>
              <p class="text-xs text-gray-400 mt-1">Start typing to search CSI codes</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Contract Amount *</label>
              <input
                type="number"
                id="contractAmount"
                required
                placeholder="50000"
                step="0.01"
                class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-green-600"
              />
              <p class="text-xs text-gray-500 mt-1">Enter amount in dollars</p>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Scope of Work *</label>
            <textarea
              id="scopeOfWork"
              required
              rows="3"
              placeholder="Describe the scope of work for this M/WBE participant..."
              class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-green-600"
            ></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Percentage of Total (auto-calculated)</label>
            <input
              type="number"
              id="percentageOfTotal"
              readonly
              placeholder="Auto-calculated from contract amount"
              class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-400"
              value="${totalEstimatedValue > 0 ? '' : '0'}"
            />
          </div>

          <div class="flex justify-end gap-3 pt-4">
            <button
              type="button"
              onclick="closeMWBEModal()"
              class="px-6 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium"
            >
              Add Participant
            </button>
          </div>
        </form>
      </div>
    `;

    document.body.appendChild(modal);

    // Initialize CSI autocomplete for M/WBE
    let mwbeCsiCode = '';
    let mwbeCsiDivision = '';
    const mwbeCSIAutocomplete = new CSIAutocomplete({
      searchInputId: 'mwbe-csi-search',
      dropdownId: 'mwbe-csi-dropdown',
      onSelect: (code, division, title) => {
        mwbeCsiCode = code;
        mwbeCsiDivision = division;
        document.getElementById('mwbe-csi-code').value = code;
        document.getElementById('mwbe-csi-division').value = division;
      }
    });

    // Auto-calculate percentage when contract amount changes
    const contractAmountInput = document.getElementById('contractAmount');
    const percentageInput = document.getElementById('percentageOfTotal');

    contractAmountInput.addEventListener('input', () => {
      const amount = parseFloat(contractAmountInput.value) || 0;
      if (totalEstimatedValue > 0) {
        const percentage = Math.round((amount * 100 / (totalEstimatedValue / 100)) * 100) / 100;
        percentageInput.value = percentage.toString();
      }
    });

    const form = document.getElementById('add-mwbe-form');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const contractAmount = parseFloat(document.getElementById('contractAmount').value);
      const percentageOfTotal = totalEstimatedValue > 0
        ? Math.round((contractAmount / (totalEstimatedValue / 100)) * 100) / 100
        : 0;

      const formData = {
        bidPackageId,
        companyName: document.getElementById('companyName').value,
        certificationType: document.getElementById('certificationType').value || null,
        certificationNumber: document.getElementById('certificationNumber').value || null,
        csiDivision: mwbeCsiCode || document.getElementById('mwbe-csi-code').value || null,
        scopeOfWork: document.getElementById('scopeOfWork').value,
        contractAmount: Math.round(contractAmount * 100),
        percentageOfTotal,
        isCommitted: false,
        isAwarded: false,
      };

      const response = await fetch('/api/bidding/mwbe', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData),
      });

      const result = await response.json();
      if (result.success) {
        window.location.reload();
      } else {
        alert('Error adding M/WBE participant: ' + result.error);
      }
    });
  }

  async function toggleMWBECommitment(participantId, isCommitted) {
    const response = await fetch(`/api/bidding/mwbe/${participantId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ isCommitted }),
    });

    const result = await response.json();
    if (result.success) {
      window.location.reload();
    } else {
      alert('Error updating M/WBE participant: ' + result.error);
    }
  }

  async function deleteMWBEParticipant(participantId) {
    if (!confirm('Are you sure you want to delete this M/WBE participant?')) {
      return;
    }

    const response = await fetch(`/api/bidding/mwbe/${participantId}`, {
      method: 'DELETE',
    });

    const result = await response.json();
    if (result.success) {
      window.location.reload();
    } else {
      alert('Error deleting M/WBE participant: ' + result.error);
    }
  }

  function closeMWBEModal() {
    const modal = document.getElementById('add-mwbe-modal');
    if (modal) modal.remove();
  }

  window.updateStatus = updateStatus;
  window.linkEstimate = linkEstimate;
  window.performLinkEstimate = performLinkEstimate;
  window.unlinkEstimate = unlinkEstimate;
  window.closeStatusModal = closeStatusModal;
  window.closeLinkModal = closeLinkModal;
  window.addQuote = addQuote;
  window.toggleQuoteAcceptance = toggleQuoteAcceptance;
  window.deleteQuote = deleteQuote;
  window.closeQuoteModal = closeQuoteModal;
  window.addMWBEParticipant = addMWBEParticipant;
  window.toggleMWBECommitment = toggleMWBECommitment;
  window.deleteMWBEParticipant = deleteMWBEParticipant;
  window.closeMWBEModal = closeMWBEModal;
</script>
