---
/**
 * Contacts Page
 * Manage all project contacts organized by CSI divisions
 */
import Layout from '../../../layouts/Layout.astro';
import ProjectModuleNav from '../../../components/ProjectModuleNav.tsx';
import ProjectHeader from '../../../components/ProjectHeader.tsx';
import ContactManagerEnhanced from '../../../components/ContactManagerEnhanced.tsx';
import SubcontractContactMigration from '../../../components/SubcontractContactMigration.tsx';

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/projects');
}

const projectId = parseInt(id);

// Fetch project details
let project = null;
try {
  const response = await fetch(`${Astro.url.origin}/api/projects/${id}`);
  if (response.ok) {
    project = await response.json();
  }
} catch (error) {
  console.error('Error fetching project:', error);
}

if (!project) {
  return Astro.redirect('/projects');
}
---

<Layout title={`Contacts - ${project.projectName}`}>
  <div class="min-h-screen bg-gray-900">
    <!-- Project Header -->
    <ProjectHeader project={project} client:load />

    <!-- Module Navigation -->
    <ProjectModuleNav projectId={projectId} activeModule="contacts" client:load />

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 py-8">
      <!-- Page Header -->
      <div class="mb-6">
        <h1 class="text-3xl font-bold text-white">Contact Management</h1>
        <p class="mt-2 text-gray-400">
          Manage subcontractors, suppliers, and vendors organized by CSI divisions.
          Extract contact information automatically from project communications.
        </p>
      </div>

      <!-- Info Banner -->
      <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
        <div class="flex">
          <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
            </svg>
          </div>
          <div class="ml-3">
            <p class="text-sm text-blue-700">
              <strong>Automatic Contact Extraction:</strong> Click "Extract from Communications" to automatically scan emails,
              RFIs, submittals, and other documents to find and update contact information. The system will organize contacts
              by CSI division based on their trade and scope of work.
            </p>
          </div>
        </div>
      </div>

      <!-- Division Overview Cards -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow p-4">
          <div class="flex items-center">
            <div class="flex-shrink-0 bg-blue-500 rounded-md p-3">
              <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
              </svg>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-500">Total Contacts</p>
              <p class="text-2xl font-semibold text-white" id="total-contacts">-</p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-4">
          <div class="flex items-center">
            <div class="flex-shrink-0 bg-green-500 rounded-md p-3">
              <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-500">Verified</p>
              <p class="text-2xl font-semibold text-white" id="verified-contacts">-</p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-4">
          <div class="flex items-center">
            <div class="flex-shrink-0 bg-purple-500 rounded-md p-3">
              <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
              </svg>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-500">Subcontractors</p>
              <p class="text-2xl font-semibold text-white" id="subcontractor-count">-</p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-4">
          <div class="flex items-center">
            <div class="flex-shrink-0 bg-orange-500 rounded-md p-3">
              <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
              </svg>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-500">Suppliers</p>
              <p class="text-2xl font-semibold text-white" id="supplier-count">-</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Subcontract Migration Component -->
      <SubcontractContactMigration projectId={projectId} client:load />

      <!-- Contact Manager Component -->
      <ContactManagerEnhanced projectId={projectId} client:load />
    </div>
  </div>
</Layout>

<style>
  /* Add any custom styles here */
</style>
