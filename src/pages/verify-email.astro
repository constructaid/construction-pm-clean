---
/**
 * Email Verification Page
 * Verifies user's email address using token from URL
 */
import Layout from '../layouts/Layout.astro';

// Get token from URL query parameter
const url = new URL(Astro.request.url);
const token = url.searchParams.get('token') || '';
---

<Layout title="Verify Email - ConstructAid">
  <div class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8">
      <div>
        <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
          Email Verification
        </h2>
      </div>

      <!-- Verifying state -->
      <div id="verifying-state">
        <div class="text-center">
          <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
          <p class="text-gray-600">Verifying your email address...</p>
        </div>
      </div>

      <!-- Success message -->
      <div id="success-state" class="hidden">
        <div class="rounded-md bg-green-50 p-6">
          <div class="flex items-center justify-center mb-4">
            <svg class="h-16 w-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <h3 class="text-center text-lg font-semibold text-green-900 mb-2">
            Email Verified Successfully!
          </h3>
          <p class="text-center text-green-700 mb-4">
            Your email address has been verified. You can now log in to your account.
          </p>
          <div class="text-center">
            <a href="/login" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
              Go to Login
            </a>
          </div>
        </div>
      </div>

      <!-- Error message -->
      <div id="error-state" class="hidden">
        <div class="rounded-md bg-red-50 p-6">
          <div class="flex items-center justify-center mb-4">
            <svg class="h-16 w-16 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <h3 class="text-center text-lg font-semibold text-red-900 mb-2">
            Verification Failed
          </h3>
          <p id="error-message" class="text-center text-red-700 mb-4">
            This verification link is invalid or has expired.
          </p>
          <div class="text-center space-y-2">
            <button
              id="resend-btn"
              class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700"
            >
              Resend Verification Email
            </button>
            <div>
              <a href="/login" class="text-sm text-blue-600 hover:text-blue-500">
                Back to Login
              </a>
            </div>
          </div>
        </div>

        <!-- Resend email form -->
        <div id="resend-form" class="hidden mt-4">
          <form id="resend-verification-form">
            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">
              Email Address
            </label>
            <input
              id="email"
              name="email"
              type="email"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
              placeholder="your.email@company.com"
            />
            <button
              type="submit"
              id="resend-submit-btn"
              class="mt-3 w-full inline-flex justify-center items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-green-600 hover:bg-green-700"
            >
              Send Verification Email
            </button>
          </form>
        </div>

        <!-- Resend success message -->
        <div id="resend-success" class="hidden mt-4">
          <div class="rounded-md bg-green-50 p-4">
            <p class="text-sm text-green-700 text-center">
              Verification email sent! Please check your inbox.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  const token = new URLSearchParams(window.location.search).get('token');
  const verifyingState = document.getElementById('verifying-state')!;
  const successState = document.getElementById('success-state')!;
  const errorState = document.getElementById('error-state')!;
  const errorMessage = document.getElementById('error-message')!;
  const resendBtn = document.getElementById('resend-btn')!;
  const resendForm = document.getElementById('resend-form')!;
  const resendSuccess = document.getElementById('resend-success')!;
  const resendVerificationForm = document.getElementById('resend-verification-form') as HTMLFormElement;
  const resendSubmitBtn = document.getElementById('resend-submit-btn') as HTMLButtonElement;

  async function verifyEmail() {
    if (!token) {
      showError('No verification token provided. Please check your email for the verification link.');
      return;
    }

    try {
      const response = await fetch('/api/auth/verify-email', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ token }),
      });

      const data = await response.json();

      if (response.ok) {
        // Show success
        verifyingState.classList.add('hidden');
        successState.classList.remove('hidden');
      } else {
        // Show error
        showError(data.message || 'Verification failed. Please try again.');
      }
    } catch (error) {
      console.error('Verification error:', error);
      showError('An unexpected error occurred. Please try again.');
    }
  }

  function showError(message: string) {
    verifyingState.classList.add('hidden');
    errorMessage.textContent = message;
    errorState.classList.remove('hidden');
  }

  // Show resend form
  resendBtn.addEventListener('click', () => {
    resendBtn.classList.add('hidden');
    resendForm.classList.remove('hidden');
  });

  // Handle resend form submission
  resendVerificationForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const emailInput = document.getElementById('email') as HTMLInputElement;
    const email = emailInput.value;

    // Disable button
    resendSubmitBtn.disabled = true;
    resendSubmitBtn.textContent = 'Sending...';

    try {
      const response = await fetch('/api/auth/resend-verification', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email }),
      });

      if (response.ok) {
        // Show success message
        resendForm.classList.add('hidden');
        resendSuccess.classList.remove('hidden');
      } else {
        alert('Failed to send verification email. Please try again.');
      }
    } catch (error) {
      console.error('Resend error:', error);
      alert('An unexpected error occurred. Please try again.');
    } finally {
      // Re-enable button
      resendSubmitBtn.disabled = false;
      resendSubmitBtn.textContent = 'Send Verification Email';
    }
  });

  // Verify email on page load
  verifyEmail();
</script>

<style>
  /* Additional styling if needed */
</style>
